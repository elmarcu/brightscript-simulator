# BrightScript Simulator (Dockerized)

A lightweight **BrightScript simulator** running in a **Node.js + Docker** environment â€” designed to let you execute and iterate on Roku `.brs` projects directly from your browser.

This is **not a full Roku device emulator**, but a generic simulator built on top of [`brs`](https://github.com/sjbarag/brs), the open-source BrightScript interpreter.  
Currently, it supports simple script execution and live reload, with plans to expand toward UI scene simulation.

---

## ğŸ§© Overview

The simulator runs a Node.js web server that:
- Watches your BrighterScript project (`source/**/*.bs`) for changes (hot-reload).
- **Compiles** BrighterScript â†’ BrightScript using `bsc` (from the `brighterscript` package).
- **Generates** compiled `.brs` files into the project's `dist/` directory (staging dir).
- Serves a **web UI** with:
  - **Build log** showing compile status, errors, and warnings.
  - **Compiled file viewer** for inspecting generated `.brs` source code.
  - **Execute button** to run the compiled code via the `brs` CLI and display runtime output.
- Uses **Server-Sent Events (SSE)** to stream logs live to connected browser clients.

This is intended as a **local dev environment** to quickly test BrightScript logic (console output), not full Roku SceneGraph rendering.

---

## ğŸ³ Docker Setup

`docker-compose.yml` example:

```yaml
services:
  brs-sim:
    build: .
    container_name: brs-sim
    ports:
      - "8080:8080"
    environment:
      - PROJECT_PATH=/app/projects
      - PROJECT=hello-world
      - FILE=source/main.brs
      - PORT=8080
    volumes:
      - ./projects:/app/projects
    working_dir: /app/projects/hello-world
```

### Build and Run

```bash
docker compose up --build
```

Then open in your browser:

```
http://localhost:8080
```

You will see:
- **Build Log**: Live updates as you edit `.bs` files.
- **Compiled Files**: Click a file tab to view the generated `.brs` code.
- **Execute Button**: Run the compiled code and see runtime `stdout` output.

---

## ğŸ—‚ï¸ Project Structure

```
.
â”œâ”€â”€ Dockerfile                   # Node 18 + brighterscript + brs
â”œâ”€â”€ docker-compose.yml          # Service config with hot-reload mounts
â”œâ”€â”€ server.js                   # Express server + watcher + compile/execute orchestration
â”œâ”€â”€ package.json                # Dependencies: express, brighterscript, brs, chokidar
â”œâ”€â”€ public/                     # Static web UI (build log, file viewer, Execute button)
â”œâ”€â”€ projects/
â”‚   â””â”€â”€ hello-world/
â”‚       â”œâ”€â”€ bsconfig.json       # BrighterScript compiler config
â”‚       â”œâ”€â”€ manifest            # Roku manifest (metadata)
â”‚       â”œâ”€â”€ source/             # BrighterScript source (.bs files)
â”‚       â”‚   â”œâ”€â”€ main.bs
â”‚       â”‚   â””â”€â”€ greet.bs
â”‚       â””â”€â”€ dist/               # Generated by bsc (staging dir)
â”‚           â””â”€â”€ source/
â”‚               â”œâ”€â”€ main.brs    # Compiled from main.bs
â”‚               â”œâ”€â”€ greet.brs   # Compiled from greet.bs
â”‚               â””â”€â”€ bslib.brs   # Runtime library (auto-included)
```

### Sample BrighterScript app

`projects/hello-world/source/main.bs`

```brighterscript
import "./greet.bs"

sub main() as void
    print "Hello from main.bs"
    Greet.Greet_Hello("developer")
end sub

main()
```

`projects/hello-world/source/greet.bs`

```brighterscript
namespace Greet

function Greet_Hello(name as string)
    print "Hello " + name
end function

end namespace
```

When you click **Execute**, the server runs the compiled `.brs` files (via `npx brs`) and displays output:
```
Hello from main.bs
Hello developer
```

---

## ğŸ§  How It Works

1. **Watch**: `chokidar` monitors `projects/<PROJECT>/source/**/*.bs` for changes.
2. **Compile**: On file change, runs `npx bsc --project bsconfig.json` (with `cwd` set to the project folder) to transpile BrighterScript â†’ BrightScript into `dist/source/`.
3. **List**: Scans `dist/` for compiled `.brs` files and broadcasts "Build completed" to all connected UI clients via SSE.
4. **Serve UI**: `/` serves a web page with a build log (live streamed), a compiled-files viewer, and an Execute button.
5. **Execute**: `GET /execute` runs `npx brs <compiled-files...>` (excluding `bslib.brs`) and returns runtime `stdout`.

**Important notes:**
- The compiler runs from the project directory so `stagingDir: "dist"` resolves correctly inside the project (avoiding nested `dist/dist/...` issues).
- Compiled files are filtered to exclude `bslib.brs` from execution (it's a runtime support library).
- All events (build status, errors, runtime output) are streamed to the browser via SSE so the UI stays synchronized.

---

## ğŸ”§ Environment Variables

| Variable        | Default / Example         | Description |
|-----------------|---------------------------|-------------|
| `PROJECT_PATH`  | `/app/projects`           | Root directory of projects |
| `PROJECT`       | `hello-world`             | Target project folder name |
| `FILE`          | `source/main.brs`         | Entry BrightScript file path |
| `PORT`          | `8080`                    | Port for the simulator UI |

---

## ğŸš« Limitations (for now)

- **No SceneGraph or UI rendering** â€” console-only output.
- **Limited BrightScript APIs** â€” depends on what `brs` supports.
- **No package or Roku channel bundling** â€” runs individual `.brs` files only.
- **Environment variables are not yet exposed inside BrightScript global AA.**

Planned improvements:
- Basic SceneGraph mock rendering (HTML canvas-based).
- API stubs for Roku built-ins.
- UI to edit and run scripts inline from the browser.

---

## âš™ï¸ Local Development

If you prefer to run directly without Docker:

```bash
npm install
npm start
```

Then set your `.env`:
```
PROJECT_PATH=./projects
PROJECT=hello-world
FILE=source/main.brs
PORT=8080
```

---

## ğŸ” API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| `GET`  | `/` | Web UI |
| `GET`  | `/compiled-files` | Returns JSON array of compiled `.brs` files in `dist/` |
| `GET`  | `/execute` | Runs compiled code via `npx brs` and returns `{ output: "..." }` |
| `GET`  | `/status` | Returns simulator status |
| `GET`  | `/restart` | Restarts BrightScript process |
| `GET`  | `/events` | Server-sent event stream (live logs) |

---

## ğŸ“œ License

MIT â€” free to use and extend.
